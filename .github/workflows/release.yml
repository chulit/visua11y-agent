name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24.9.0"  # sama dengan di lokal
          registry-url: "https://registry.npmjs.org"

      # 🧹 Bersihkan cache & periksa versi environment
      - name: Verify Node and npm versions
        run: |
          node -v
          npm -v
          npm cache clean --force

      - name: Check NPM token availability
        run: |
          if [ -z "${NPM_TOKEN}" ]; then
            echo "❌ NPM_TOKEN is not defined. Please set the secret in GitHub."
            exit 1
          fi
          echo "✅ NPM_TOKEN appears to be set (length ${#NPM_TOKEN})."

      # 🧩 Auto-heal step untuk menangani mismatch seperti picomatch@2 vs 4
      - name: Heal dependency tree if npm ci fails
        id: install
        run: |
          echo "🧩 Attempting npm ci..."
          if ! npm ci; then
            echo "⚠️ npm ci failed. Running recovery steps..."
            npm install --legacy-peer-deps
            npm dedupe
            echo "✅ Dependencies healed successfully."
          fi

      # 🏗️ Build project
      - name: Build project
        run: npm run build

      # 🚀 Release ke npm dan GitHub
      - name: Release
        run: npm run release
